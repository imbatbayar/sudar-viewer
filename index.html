<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sudra Viewer</title>

  <style>
    :root{
      --bg0:#070707;
      --bg1:#0b0b0d;
      --wood1:#2a1a10;
      --wood2:#3b2415;
      --paper:#f4e7cf;
      --muted: rgba(255,255,255,.70);
      --line: rgba(255,255,255,.10);
      --radius: 22px;
    }

    html,body{
      height:100%;
      margin:0;
      background:
        radial-gradient(1200px 600px at 50% 0%, rgba(255,200,120,.10), transparent 60%),
        radial-gradient(900px 500px at 20% 20%, rgba(255,255,255,.06), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:#f3f3f4;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      overflow:hidden;
    }

    .wrap{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      box-sizing:border-box;
    }

    .scene{
      width:min(1020px, 100%);
      height:min(92vh, 860px);
      position:relative;
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: 0 30px 90px rgba(0,0,0,.60);
      border: 1px solid rgba(255,255,255,.08);
      background:
        radial-gradient(900px 600px at 50% 10%, rgba(255,255,255,.08), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    }

    /* Reader area */
    .book{
      position:absolute;
      left:18px; right:18px; top:18px; bottom:158px;
      border-radius: 20px;
      background:
        radial-gradient(1200px 700px at 50% 20%, rgba(255,225,175,.10), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.18));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
      overflow:hidden;
    }

    /* Stand */
    .stand{
      position:absolute;
      left:18px; right:18px; bottom:46px;
      height:120px;
      border-radius: 18px;
      background:
        linear-gradient(135deg, rgba(255,255,255,.06), transparent 35%),
        linear-gradient(0deg, rgba(0,0,0,.55), rgba(0,0,0,.10)),
        repeating-linear-gradient(90deg, rgba(255,255,255,.06) 0 6px, rgba(255,255,255,.02) 6px 14px),
        linear-gradient(180deg, var(--wood2), var(--wood1));
      border:1px solid rgba(255,255,255,.12);
      box-shadow:
        0 18px 40px rgba(0,0,0,.50),
        inset 0 1px 0 rgba(255,255,255,.12);
      transform: perspective(900px) rotateX(12deg);
      transform-origin: bottom center;
    }

    /* Top bar */
    .topbar{
      position:absolute;
      left:16px; right:16px; top:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border-radius: 16px;
      background: rgba(0,0,0,.40);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(8px);
      z-index: 50;
    }
    .title{
      display:flex;
      gap:10px;
      align-items:center;
      min-width:0;
    }
    .badge{
      width:26px; height:26px;
      border-radius: 10px;
      display:grid;
      place-items:center;
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.12);
      font-size:14px;
      flex:0 0 auto;
    }
    .txt{min-width:0;}
    .h{
      font-weight:800;
      letter-spacing:.2px;
      font-size:13px;
      color:#f4f1ea;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .s{
      font-size:12px;
      color: rgba(255,255,255,.60);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      margin-top:2px;
    }

    .controls{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color:#fff;
      padding:8px 10px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:750;
      font-size:12px;
      line-height:1;
      user-select:none;
    }
    .btn:disabled{opacity:.35; cursor:not-allowed;}
    .counter{
      font-size:12px;
      color: rgba(255,255,255,.70);
      padding:8px 10px;
      border-radius: 14px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      min-width:64px;
      text-align:center;
    }

    /* Stage */
    .stage{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:56px 18px 18px 18px;
      box-sizing:border-box;
    }

    .paper{
      width:min(860px, 100%);
      height:100%;
      border-radius: 18px;
      position:relative;
      perspective: 1200px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .paperFrame{
      position:absolute;
      inset:0;
      border-radius: 18px;
      background:
        radial-gradient(900px 500px at 50% 10%, rgba(255,245,220,.18), transparent 60%),
        linear-gradient(180deg, rgba(255,230,190,.10), rgba(0,0,0,.15));
      border:1px solid rgba(255,255,255,.10);
      box-shadow:
        0 22px 70px rgba(0,0,0,.45),
        inset 0 1px 0 rgba(255,255,255,.14);
      pointer-events:none;
    }

    img.page{
      max-width:100%;
      max-height:100%;
      border-radius: 14px;
      background: var(--paper);
      box-shadow:
        0 10px 40px rgba(0,0,0,.45),
        inset 0 0 0 1px rgba(0,0,0,.06);
      user-select:none;
      -webkit-user-drag:none;
      transform: translateZ(0);
    }

    /* Flip overlay */
    .flipOverlay{
      position:absolute;
      inset:0;
      border-radius: 18px;
      overflow:hidden;
      pointer-events:none;
    }
    .flipSheet{
      position:absolute;
      inset:0;
      transform-origin: top center;
      border-radius: 14px;
      overflow:hidden;
      background: var(--paper);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      will-change: transform;
    }
    .flipSheet img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      background: var(--paper);
    }
    .foldShadow{
      position:absolute;
      inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.62), rgba(0,0,0,0) 58%);
      opacity:0;
      will-change: opacity;
    }

    /* Footer (always visible) */
    .footer{
      position:absolute;
      left:18px; right:18px; bottom:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      font-size:12px;
      color: rgba(255,255,255,.72);
      z-index: 60;            /* üëà book/stand –¥—ç—ç—Ä—ç—ç—Å –≥–∞—Ä–≥–∞–∂ –∏—Ä–Ω—ç */
      pointer-events:none;
    }
    .footer b{color:#fff; font-weight:850;}
    .dot{width:5px;height:5px;border-radius:99px;background:rgba(255,255,255,.35);}

    @media (max-width:560px){
      .scene{height:92vh;}
      .book{bottom:150px;}
      .stand{height:110px;}
      .s{display:none;}
      .counter{min-width:auto;}
      .paper{width:100%;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="scene">
      <div class="book" id="book">
        <div class="topbar">
          <div class="title">
            <div class="badge">üìú</div>
            <div class="txt">
              <div class="h">”®—Ä–≥”©”© –≥—ç—Ä–∏–π–Ω –º–∞–∞–Ω–∏ </div>
              <div class="s">–î—ç—ç—à/–¥–æ–æ—à –≥“Ø–π–ª–≥—ç—ç–¥ —Ö—É—É–¥–∞—Å —Å–æ–ª–∏–≥–¥–æ–Ω–æ</div>
            </div>
          </div>

          <div class="controls">
            <button class="btn" id="exit" type="button">‚üµ –ì–∞—Ä–∞—Ö</button>
            <button class="btn" id="prev" type="button">‚¨Ü ”®–º–Ω”©—Ö</button>
            <button class="btn" id="next" type="button">‚¨á –î–∞—Ä–∞–∞—Ö</button>
            <div class="counter" id="counter">1 / 1</div>
          </div>

        </div>

        <div class="stage">
          <div class="paper">
            <div class="paperFrame"></div>

            <img class="page" id="pageImg" alt="Sudra page" />
            <div class="flipOverlay" id="flipOverlay" aria-hidden="true"></div>
          </div>
        </div>
      </div>

      <div class="stand"></div>

      <div class="footer">
        <span>Developed by <b>Bodisadva</b></span>
      </div>
    </div>
  </div>

  <script>
    // ‚úÖ –ó—É—Ä–≥—É—É–¥ —á–∏–Ω—å repo root –¥—ç—ç—Ä –±–∞–π–≥–∞–∞: 158.jpg ...
    const PAGES = ["158.jpg","159.jpg","160.jpg","161.jpg","162.jpg"];

    const book = document.getElementById("book");
    const img = document.getElementById("pageImg");
    const flipOverlay = document.getElementById("flipOverlay");
    const counter = document.getElementById("counter");
    const prevBtn = document.getElementById("prev");
    const nextBtn = document.getElementById("next");
    const exitBtn = document.getElementById("exit");


    let i = 0;
    let lock = false;

    // --- Preload (–∞–Ω–∏–≤—á–∏–ª—Ç –∞—Ä–∏–ª–≥–∞–Ω–∞)
    const cache = new Map();
    function preload(src){
      if (cache.has(src)) return cache.get(src);
      const im = new Image();
      const p = new Promise((res, rej) => {
        im.onload = () => res(src);
        im.onerror = () => rej(new Error("Failed: " + src));
      });
      im.src = src;
      cache.set(src, p);
      return p;
    }

    function ui(){
      counter.textContent = `${i+1} / ${PAGES.length}`;
      prevBtn.disabled = (i === 0) || lock;
      nextBtn.disabled = (i === PAGES.length - 1) || lock;
    }

    function setBase(src){
      img.src = src;
    }

    // --- Smooth vertical flip
    async function flipTo(ni){
      if (lock) return;
      if (ni < 0 || ni >= PAGES.length) return;

      lock = true;
      ui();

      const from = PAGES[i];
      const to = PAGES[ni];

      // preload both images to avoid blink
      try{
        await Promise.all([preload(from), preload(to)]);
      }catch(e){
        // fallback: just swap
        setBase(to);
        i = ni;
        lock = false;
        ui();
        return;
      }

      // prepare overlay sheet with FROM page
      flipOverlay.innerHTML = "";
      const sheet = document.createElement("div");
      sheet.className = "flipSheet";
      const sheetImg = document.createElement("img");
      sheetImg.src = from;
      const shadow = document.createElement("div");
      shadow.className = "foldShadow";
      sheet.appendChild(sheetImg);
      sheet.appendChild(shadow);
      flipOverlay.appendChild(sheet);

      // put TO page underneath (base) BEFORE animation starts
      setBase(to);

      // animate folding upward
      const D = 720; // longer = smoother
      const start = performance.now();

      function ease(t){
        return t < 0.5 ? 4*t*t*t : 1 - Math.pow(-2*t + 2, 3)/2;
      }

      function tick(now){
        const t = Math.min(1, (now - start) / D);
        const e = ease(t);

        // fold: 0 -> -95deg
        const deg = -95 * e;
        sheet.style.transform = `rotateX(${deg}deg)`;

        // shadow: strongest mid-fold
        shadow.style.opacity = String(Math.sin(Math.PI * e) * 0.62);

        if (t < 1) requestAnimationFrame(tick);
        else{
          // finish
          flipOverlay.innerHTML = "";
          i = ni;
          lock = false;
          ui();
        }
      }

      requestAnimationFrame(tick);
    }

    function go(delta){
      const ni = i + delta;
      flipTo(ni);
    }

    // ‚úÖ Buttons (works)
    prevBtn.addEventListener("click", () => go(-1));
    nextBtn.addEventListener("click", () => go(1));
    // ‚úÖ Exit button (back to Google Sites home)
      const RETURN_URL = "https://sites.google.com/view/bodisadva/home-mantra";
      
      exitBtn.addEventListener("click", () => {
        try {
          if (window.top !== window.self) {
            window.top.location.href = RETURN_URL;
            return;
          }
        } catch (e) {}
        window.location.href = RETURN_URL;
      });

    // wheel / trackpad
    let wheelAccum = 0;
    let wheelTimer = null;
    book.addEventListener("wheel", (e)=>{
      e.preventDefault();
      if (lock) return;

      wheelAccum += e.deltaY;
      clearTimeout(wheelTimer);
      wheelTimer = setTimeout(()=>{ wheelAccum = 0; }, 140);

      const TH = 140;
      if (wheelAccum > TH){ wheelAccum = 0; go(1); }
      if (wheelAccum < -TH){ wheelAccum = 0; go(-1); }
    }, {passive:false});

    // swipe
    let y0 = null;
    book.addEventListener("touchstart", (e)=>{ y0 = e.touches[0].clientY; }, {passive:true});
    book.addEventListener("touchend", (e)=>{
      if (y0 === null || lock) return;
      const y1 = e.changedTouches[0].clientY;
      const dy = y1 - y0;
      y0 = null;
      const TH = 42;
      if (dy > TH) go(-1);
      else if (dy < -TH) go(1);
    }, {passive:true});

    // keyboard
    window.addEventListener("keydown", (e)=>{
      if (lock) return;
      if (e.key === "ArrowDown" || e.key === "PageDown") go(1);
      if (e.key === "ArrowUp" || e.key === "PageUp") go(-1);
    });

    // init
    (async ()=>{
      // preload first 2 pages to make first flip smooth
      await preload(PAGES[0]).catch(()=>{});
      if (PAGES[1]) await preload(PAGES[1]).catch(()=>{});
      setBase(PAGES[0]);
      ui();
    })();
  </script>
</body>
</html>
